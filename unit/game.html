<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>åˆæˆå¤§åˆç…§ â¤ï¸</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #ffeaa7; overflow: hidden; font-family: "Microsoft YaHei", sans-serif; user-select: none; -webkit-tap-highlight-color: transparent;}
        
        #game-container {
            position: relative; width: 100%; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        /* é¡¶éƒ¨ UI */
        .header-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box; pointer-events: none; z-index: 10;
        }
        .score-box {
            background: rgba(255,255,255,0.9); padding: 5px 15px;
            border-radius: 20px; font-weight: bold; color: #d63031; font-size: 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-rank {
            background: #0984e3; color: white; padding: 8px 15px;
            border-radius: 20px; font-size: 14px; pointer-events: auto; cursor: pointer;
            border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3);
        }

        /* è¿å‡»ç‰¹æ•ˆæ–‡å­— */
        .combo-text {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%) scale(0);
            font-size: 40px; font-weight: 900; color: #ff7675;
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff;
            pointer-events: none; z-index: 20;
            transition: transform 0.1s; opacity: 0;
        }
        .combo-text.active {
            animation: popCombo 0.5s ease-out;
        }
        @keyframes popCombo {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* é€šç”¨å¼¹çª— */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 99;
            display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .card {
            background: white; width: 80%; max-width: 320px; padding: 25px; 
            border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        
        /* è§’è‰²é€‰æ‹©æŒ‰é’® */
        .role-btn {
            display: block; width: 100%; margin: 10px 0; padding: 15px;
            border: 2px solid #eee; border-radius: 12px; background: white;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .role-btn:active { transform: scale(0.95); background: #f1f2f6; }
        .role-btn.boy { border-color: #74b9ff; color: #0984e3; }
        .role-btn.girl { border-color: #ff7675; color: #d63031; }

        /* æ’è¡Œæ¦œæ ·å¼ */
        .rank-list {
            list-style: none; padding: 0; text-align: left; max-height: 250px; overflow-y: auto; margin: 10px 0;
        }
        .rank-item {
            display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px dashed #eee;
        }
        .rank-close {
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="game-container"></div>

    <div class="header-ui">
        <div class="score-box">å¾—åˆ†: {{ Math.floor(currentScore) }}</div>
        <button class="btn-rank" @click="openRank">ğŸ† æ’è¡Œæ¦œ</button>
    </div>

    <div class="combo-text" :class="{active: showComboAnim}" :key="comboCount">
        Combo x{{ comboCount }}!
    </div>

    <div class="modal-overlay" :class="{show: showRoleSelect}">
        <div class="card">
            <h2>ä½ æ˜¯è°å‘€ï¼ŸğŸ‘€</h2>
            <p style="color:#999; margin-bottom:20px;">é€‰ä¸€æ¬¡å°±å¥½å•¦ï¼Œæ–¹ä¾¿è®°å½•æˆ˜ç»©</p>
            <button class="role-btn boy" @click="selectRole('ğŸ‘¦ å“¥å“¥')">ğŸ‘¦ æˆ‘æ˜¯å“¥å“¥</button>
            <button class="role-btn girl" @click="selectRole('ğŸ‘§ å®è´')">ğŸ‘§ æˆ‘æ˜¯å®è´</button>
        </div>
    </div>

    <div class="modal-overlay" :class="{show: isGameOver}">
        <div class="card">
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p style="font-size: 32px; color:#d63031; font-weight:bold; margin:10px 0;">{{ Math.floor(currentScore) }}</p>
            <p style="color:#666">æˆç»©å·²è‡ªåŠ¨ä¸Šä¼ åˆ°æ’è¡Œæ¦œ</p>
            <button class="role-btn" style="background:#00b894; color:white; border:none;" @click="restart">å†æ¥ä¸€å±€ ğŸ”¥</button>
            <button class="role-btn" @click="openRank">æŸ¥çœ‹å®¶åº­åœ°ä½ ğŸ‘‘</button>
        </div>
    </div>

    <div class="modal-overlay" :class="{show: showRank}" @click.self="showRank = false">
        <div class="card">
            <span class="rank-close" @click="showRank = false">Ã—</span>
            <h3>ğŸ‘‘ å®¶åº­å¸ä½æ’è¡Œæ¦œ</h3>
            <ul class="rank-list">
                <li class="rank-item" v-for="(item, index) in rankList" :key="index">
                    <span>
                        <span v-if="index==0">ğŸ¥‡</span>
                        <span v-else-if="index==1">ğŸ¥ˆ</span>
                        <span v-else-if="index==2">ğŸ¥‰</span>
                        <span v-else>{{ index + 1 }}.</span>
                        {{ item.playerName }}
                    </span>
                    <span style="font-weight:bold; color:#d63031">{{ item.score }}</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;
    const API_BASE = 'https://darlingweb.onrender.com';
    const { Engine, Render, World, Bodies, Body, Events, Composite } = Matter;

    createApp({
        setup() {
            // çŠ¶æ€å˜é‡
            const currentScore = ref(0);
            const isGameOver = ref(false);
            const showRoleSelect = ref(false);
            const showRank = ref(false);
            const rankList = ref([]);
            const currentPlayer = ref(localStorage.getItem('darling_player_name') || ''); // è¯»å–ç¼“å­˜åå­—
            
            // è¿å‡»ç³»ç»Ÿ
            const comboCount = ref(0);
            const showComboAnim = ref(false);
            let lastMergeTime = 0;

            // æ¸¸æˆå¼•æ“å˜é‡
            let engine, render;
            let currentBall = null; // å½“å‰é¡¶éƒ¨çš„å°çƒ
            let isDropping = false; // æ˜¯å¦æ­£åœ¨æ‰è½ï¼ˆç¨å¾®é™åˆ¶é˜²æ­¢è¯¯è§¦ï¼‰

            // å‡çº§ï¼šæ›´å¤šçš„å°çƒç±»å‹ (11çº§)
            const ballTypes = [
                { r: 20, color: '#a29bfe', score: 2 },    // Lv0: ç´«
                { r: 30, color: '#74b9ff', score: 4 },    // Lv1: è“
                { r: 40, color: '#81ecec', score: 8 },    // Lv2: é’
                { r: 50, color: '#55efc4', score: 16 },   // Lv3: ç»¿
                { r: 60, color: '#ffeaa7', score: 32 },   // Lv4: é»„
                { r: 70, color: '#fab1a0', score: 64 },   // Lv5: æ©™
                { r: 80, color: '#ff7675', score: 128 },  // Lv6: çº¢
                { r: 90, color: '#fd79a8', score: 256 },  // Lv7: ç²‰
                { r: 100, color: '#d63031', score: 512 }, // Lv8: æ·±çº¢
                { r: 110, color: '#e17055', score: 1024 },// Lv9: ç –çº¢
                { r: 120, color: '#2d3436', score: 2048 } // Lv10: ç»ˆæé»‘æ´
            ];

            // 1. åˆå§‹åŒ–æ¸¸æˆ
            const initGame = () => {
                // å¦‚æœæ²¡é€‰è§’è‰²ï¼Œå…ˆé€‰è§’è‰²
                if (!currentPlayer.value) {
                    showRoleSelect.value = true;
                    return; // æš‚åœåˆå§‹åŒ–ï¼Œç­‰é€‰å®Œ
                }

                const container = document.getElementById('game-container');
                container.innerHTML = ''; // æ¸…ç©ºä¸Šä¸€å±€
                const width = Math.min(window.innerWidth, 450); // é€‚é…æ‰‹æœºå®½
                const height = window.innerHeight;

                engine = Engine.create();
                // è°ƒæ•´é‡åŠ›ï¼Œè®©çƒæ‰å¿«ç‚¹
                engine.gravity.y = 1.2; 

                render = Render.create({
                    element: container,
                    engine: engine,
                    options: {
                        width: width,
                        height: height,
                        wireframes: false,
                        background: 'transparent'
                    }
                });

                // è¾¹ç•Œ
                const ground = Bodies.rectangle(width/2, height, width, 60, { isStatic: true, render: { fillStyle: '#b2bec3' } });
                const leftWall = Bodies.rectangle(0, height/2, 10, height, { isStatic: true, render: { fillStyle: '#dfe6e9' } });
                const rightWall = Bodies.rectangle(width, height/2, 10, height, { isStatic: true, render: { fillStyle: '#dfe6e9' } });
                const deadLine = Bodies.rectangle(width/2, 120, width, 2, { 
                    isStatic: true, isSensor: true, label: 'DeadLine', render: { fillStyle: 'rgba(255,0,0,0.2)' } 
                });

                World.add(engine.world, [ground, leftWall, rightWall, deadLine]);

                // ç”Ÿæˆç¬¬ä¸€ä¸ªçƒ
                createNewBall(width);

                // ç‚¹å‡»äº‹ä»¶ (å¿«é€Ÿå“åº”)
                render.canvas.addEventListener('pointerdown', (e) => {
                    if (isGameOver.value || isDropping) return;
                    if (!currentBall) return;
                    
                    isDropping = true;

                    // 1. è·å–ç‚¹å‡»ä½ç½®X
                    const x = e.offsetX;
                    const safeX = Math.min(Math.max(x, 25), width - 25);
                    
                    // 2. ç¬é—´æŠŠçƒç§»è¿‡å»
                    Body.setPosition(currentBall, { x: safeX, y: 50 });
                    
                    // 3. é‡Šæ”¾çƒ
                    Body.setStatic(currentBall, false); // è®©å®ƒå—é‡åŠ›å½±å“
                    Body.setVelocity(currentBall, { x: 0, y: 5 }); // ç»™ä¸ªåˆé€Ÿåº¦è®©å®ƒå†²ä¸‹å»
                    currentBall.label = 'Ball';
                    currentBall = null;

                    // 4. æé€Ÿç”Ÿæˆä¸‹ä¸€ä¸ª (300mså†·å´é˜²æ­¢è¯¯è§¦åŒå‡»ï¼Œä½†ä½“æ„Ÿå¾ˆå¿«)
                    setTimeout(() => {
                        createNewBall(width);
                        isDropping = false;
                    }, 300);
                });

                // ç¢°æ’åˆæˆé€»è¾‘
                Events.on(engine, 'collisionStart', handleCollision);

                // æ­»äº¡æ£€æµ‹
                Events.on(engine, 'collisionActive', checkGameOver);

                Engine.run(engine);
                Render.run(render);
            };

            // ç”Ÿæˆæ–°çƒçš„é€»è¾‘ (åŒ…å«éš¾åº¦é€’å¢)
            const createNewBall = (width) => {
                // éš¾åº¦æ§åˆ¶ï¼šåˆ†æ•°è¶Šé«˜ï¼Œç”Ÿæˆçš„çƒå¯èƒ½è¶Šå¤§
                let maxLevel = 0;
                if (currentScore.value > 5000) maxLevel = 3;      // 5000åˆ†åå¯èƒ½å‡ºç»¿çƒ
                else if (currentScore.value > 1000) maxLevel = 2; // 1000åˆ†åå¯èƒ½å‡ºé’çƒ
                else maxLevel = 1;                                // åˆšå¼€å§‹åªæœ‰ç´«å’Œè“

                const level = Math.floor(Math.random() * (maxLevel + 1));
                
                const type = ballTypes[level];
                currentBall = Bodies.circle(width / 2, 50, type.r, {
                    isStatic: true, // æ‚¬åœåœ¨ç©ºä¸­
                    label: 'ReadyBall',
                    render: { fillStyle: type.color }
                });
                currentBall.level = level;
                World.add(engine.world, currentBall);
            };

            // å¤„ç†ç¢°æ’
            const handleCollision = (event) => {
                const pairs = event.pairs;
                pairs.forEach((pair) => {
                    const bodyA = pair.bodyA;
                    const bodyB = pair.bodyB;

                    if (bodyA.level !== undefined && bodyB.level !== undefined && bodyA.level === bodyB.level) {
                        if (bodyA.id === bodyB.id) return; // é¿å…è‡ªç¢°æ’

                        const midX = (bodyA.position.x + bodyB.position.x) / 2;
                        const midY = (bodyA.position.y + bodyB.position.y) / 2;
                        const nextLevel = bodyA.level + 1;

                        if (nextLevel < ballTypes.length) {
                            // ç§»é™¤æ—§çƒ
                            World.remove(engine.world, [bodyA, bodyB]);
                            
                            // ç”Ÿæˆæ–°çƒ
                            const newType = ballTypes[nextLevel];
                            const newBall = Bodies.circle(midX, midY, newType.r, {
                                restitution: 0.5, // å¼¹æ€§å¤§ä¸€ç‚¹ï¼ŒQå¼¹
                                label: 'Ball',
                                render: { fillStyle: newType.color }
                            });
                            newBall.level = nextLevel;
                            World.add(engine.world, newBall);

                            // --- è§†è§‰ç‰¹æ•ˆï¼šç®€å•çš„ç¼©æ”¾åŠ¨ç”»æ¨¡æ‹ŸQå¼¹ ---
                            // æ³¨æ„ï¼šMatter.js åŸç”Ÿç¼©æ”¾ä¼šæ”¹å˜ç‰©ç†ä½“ç§¯ï¼Œæˆ‘ä»¬åªåœ¨è¿™ä¸€ç¬é—´ç¼©æ”¾ä¸€ä¸‹
                            // å®é™…ä¸Š restitution=0.5 å·²ç»æœ‰ç‰©ç†å¼¹æ€§äº†ï¼Œè¿™é‡ŒåŠ éœ‡åŠ¨

                            // --- 1. æ‰‹æœºéœ‡åŠ¨ ---
                            if (navigator.vibrate) navigator.vibrate(15); // çŸ­ä¿ƒéœ‡åŠ¨

                            // --- 2. è¿å‡»è®¡ç®— ---
                            const now = Date.now();
                            if (now - lastMergeTime < 1500) {
                                comboCount.value++;
                            } else {
                                comboCount.value = 1; // è¿å‡»ä¸­æ–­ï¼Œé‡æ–°ç®—
                            }
                            lastMergeTime = now;

                            // è§¦å‘è¿å‡»åŠ¨ç”»
                            showComboAnim.value = false;
                            setTimeout(() => showComboAnim.value = true, 10); // é‡ç½®åŠ¨ç”»

                            // --- 3. ç®—åˆ† (å¸¦è¿å‡»åŠ æˆ) ---
                            // è¿å‡»åŠ æˆï¼šæ¯ä¸ª Combo é¢å¤–åŠ  10%
                            const bonus = 1 + (comboCount.value - 1) * 0.1;
                            currentScore.value += (newType.score * bonus);
                        }
                    }
                });
            };

            // æ­»äº¡æ£€æµ‹
            const checkGameOver = (event) => {
                if(isGameOver.value) return;
                event.pairs.forEach(pair => {
                    if (pair.bodyA.label === 'DeadLine' || pair.bodyB.label === 'DeadLine') {
                        const ball = pair.bodyA.label === 'Ball' ? pair.bodyA : pair.bodyB;
                        // åªæœ‰å½“çƒåŸºæœ¬é™æ­¢ï¼Œä¸”ä¸åœ¨æ‰è½è¿‡ç¨‹ä¸­ï¼Œä¸”åœ¨DeadLineä¸Šæ–¹åœç•™äº†ä¸€æ®µæ—¶é—´
                        if (ball.label === 'Ball' && ball.speed < 0.2 && !isDropping) {
                            // ç®€å•åˆ¤æ–­ï¼šåªè¦æœ‰çƒåœåœ¨çº¢çº¿ä¸Šï¼Œå°±æŒ‚äº†
                            triggerGameOver();
                        }
                    }
                });
            };

            const triggerGameOver = () => {
                isGameOver.value = true;
                // åœæ­¢æ¸²æŸ“æ›´æ–°
                if(render) render.options.enabled = false;
                // è‡ªåŠ¨ä¸Šä¼ åˆ†æ•°
                submitScore();
            };

            // è§’è‰²é€‰æ‹©
            const selectRole = (name) => {
                currentPlayer.value = name;
                localStorage.setItem('darling_player_name', name); // è®°ä½é€‰æ‹©
                showRoleSelect.value = false;
                initGame(); // å¼€å§‹æ¸¸æˆ
            };

            // æäº¤åˆ†æ•°
            const submitScore = async () => {
                try {
                    await fetch(`${API_BASE}/game/submit`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            playerName: currentPlayer.value,
                            score: Math.floor(currentScore.value)
                        })
                    });
                } catch(e) { console.error("åˆ†æ•°ä¸Šä¼ å¤±è´¥", e); }
            };

            const openRank = async () => {
                try {
                    const res = await fetch(`${API_BASE}/game/rank`);
                    rankList.value = await res.json();
                    showRank.value = true;
                } catch(e) {}
            };

            const restart = () => {
                location.reload();
            };

            onMounted(() => {
                // å¦‚æœæœ‰ç¼“å­˜åå­—ï¼Œç›´æ¥å¼€å§‹ï¼›å¦åˆ™ç­‰é€‰æ‹©
                if (currentPlayer.value) {
                    initGame();
                } else {
                    showRoleSelect.value = true;
                }
            });

            return { 
                currentScore, isGameOver, showRoleSelect, showRank, rankList,
                selectRole, restart, openRank,
                comboCount, showComboAnim // æš´éœ²ç»™æ¨¡æ¿ç”¨
            };
        }
    }).mount('#app');
</script>
</body>
</html>