<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘ä»¬çš„æ¸©é¦¨å°çª ğŸ </title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* --- æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ --- */
        :root {
            --primary: #6c5ce7;
            --bg: #f8f9fd;
            --card-bg: #ffffff;
        }
        body { margin: 0; padding: 0; font-family: 'PingFang SC', sans-serif; background: var(--bg); color: #2d3436; }
        
        /* é¡¶éƒ¨å¤§å¡ç‰‡ */
        .hero {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            padding: 40px 20px; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 10px 20px rgba(161, 140, 209, 0.3); text-align: center;
        }
        .hero h1 { margin: 0; font-size: 26px; }
        .hero p { opacity: 0.9; margin-top: 10px; font-size: 14px; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        /* --- å¯¼èˆªç½‘æ ¼ --- */
        .nav-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            transform: translateY(-30px); margin-bottom: 0;
        }
        .nav-item {
            background: white; border-radius: 16px; padding: 15px 10px;
            text-align: center; text-decoration: none; color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-item:active { transform: scale(0.95); }
        .nav-icon { font-size: 28px; margin-bottom: 5px; }
        .nav-text { font-size: 13px; font-weight: bold; }

        /* --- è¿›åº¦æ¡å¡ç‰‡ --- */
        .section-title { font-weight: bold; font-size: 18px; margin: 20px 0 15px; display: flex; justify-content: space-between; align-items: center; }
        .add-btn { font-size: 12px; background: #dfe6e9; padding: 5px 12px; border-radius: 20px; cursor: pointer; }
        
        .goal-card {
            background: white; border-radius: 16px; padding: 20px;
            margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            position: relative;
        }
        
        .goal-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; font-weight: bold; }
        .goal-val { color: var(--primary); }
        
        .progress-bg { height: 10px; background: #f1f2f6; border-radius: 5px; overflow: hidden; position: relative; }
        .progress-bar { 
            height: 100%; background: linear-gradient(90deg, #6c5ce7, #a29bfe); 
            border-radius: 5px; width: 0%; transition: width 1s ease;
        }
        
        .goal-footer { 
            margin-top: 8px; font-size: 12px; color: #b2bec3; 
            display: flex; justify-content: space-between; 
        }

        /* ç®€å•çš„æ“ä½œæŒ‰é’® */
        .action-row { margin-top: 15px; text-align: right; border-top: 1px dashed #eee; padding-top: 10px; }
        .sm-btn { font-size: 12px; color: #636e72; margin-left: 10px; cursor: pointer; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 999;
        }
        .modal { background: white; padding: 20px; border-radius: 16px; width: 80%; max-width: 320px; }
        .form-item { margin-bottom: 15px; }
        .form-item label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
        .form-item input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; }
        .btn-close { width: 100%; padding: 10px; background: #f1f2f6; color: #666; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer;}
    </style>
</head>
<body>

<div id="app">
    <div class="hero">
        <h1>Welcome Back â¤ï¸</h1>
        <p>ä»Šå¤©æ˜¯çˆ±ä½ çš„ç¬¬ {{ daysInLove }} å¤©</p>
    </div>

    <div class="container">
        <div class="nav-grid">
            <a href="unit/coupons.html" class="nav-item">
                <span class="nav-icon">ğŸŸï¸</span>
                <span class="nav-text">å…‘æ¢åˆ¸</span>
            </a>
            <a href="unit/decision.html" class="nav-item">
                <span class="nav-icon">ğŸ¡</span>
                <span class="nav-text">å¸®æˆ‘é€‰</span>
            </a>
            <a href="unit/daoqian.html" class="nav-item">
                <span class="nav-icon">ğŸ¥º</span>
                <span class="nav-text">å°å‰§åœº</span>
            </a>
        </div>

        <div class="section-title">
            <span>ğŸ“ˆ æˆ‘ä»¬çš„æˆé•¿è®¡åˆ’</span>
            <span class="add-btn" @click="openModal()">+ æ–°å»º</span>
        </div>

        <div v-if="loading" style="text-align:center; padding:20px; color:#999;">
            æ­£åœ¨åŠ è½½æ•°æ®...
        </div>

        <div v-if="!loading && goals.length === 0" style="text-align:center; color:#ccc; padding:20px;">
            è¿˜æ²¡æœ‰å®šå°ç›®æ ‡å“¦ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ–°å»ºâ€æ·»åŠ ä¸€ä¸ªå§~
        </div>

        <div class="goal-card" v-for="goal in goals" :key="goal.id">
            <div class="goal-header">
                <span>{{ goal.title }}</span>
                <span class="goal-val">{{ goal.currentVal }} / {{ goal.targetVal }} {{ goal.unit }}</span>
            </div>
            
            <div class="progress-bg">
                <div class="progress-bar" :style="{ width: getPercent(goal) + '%' }"></div>
            </div>

            <div class="goal-footer">
                <span>è¿›åº¦: {{ getPercent(goal) }}%</span>
                <span>ç›®æ ‡: {{ goal.targetVal }} {{ goal.unit }}</span>
            </div>

            <div class="action-row">
                <span class="sm-btn" @click="openModal(goal)">âœï¸ æ›´æ–°</span>
                <span class="sm-btn" @click="deleteGoal(goal.id)" style="color:#ff7675;">ğŸ—‘ï¸ åˆ é™¤</span>
            </div>
        </div>
    </div>

    <div class="modal-mask" v-if="showModal" @click.self="showModal=false">
        <div class="modal">
            <h3 style="margin-top:0">{{ form.id ? 'æ›´æ–°è¿›åº¦' : 'æ–°å»ºç›®æ ‡' }}</h3>
            
            <div class="form-item">
                <label>ç›®æ ‡åç§°</label>
                <input v-model="form.title" placeholder="ä¾‹å¦‚ï¼šæ”’é»„é‡‘">
            </div>
            <div class="form-item">
                <label>å½“å‰æ•°å€¼</label>
                <input type="number" v-model="form.currentVal" placeholder="0" step="0.1">
            </div>
            <div class="form-item">
                <label>ç›®æ ‡æ€»æ•°</label>
                <input type="number" v-model="form.targetVal" placeholder="100" step="0.1">
            </div>
            <div class="form-item">
                <label>å•ä½</label>
                <input v-model="form.unit" placeholder="ä¾‹å¦‚ï¼šå…‹/å¤©/ä¸ª">
            </div>

            <button class="btn-submit" @click="submitForm">ä¿å­˜æäº¤</button>
            <button class="btn-close" @click="showModal=false">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;
    
    // âœ… ä½ çš„çœŸå®åç«¯åœ°å€
    const API_BASE = 'https://darlingweb.onrender.com';

    createApp({
        setup() {
            // --- æ—¥æœŸé€»è¾‘ ---
            // ä¿®æ”¹è¿™é‡Œä¸ºä½ ä»¬åœ¨ä¸€èµ·çš„æ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DD
            const startData = new Date('2025-09-25'); 
            const now = new Date();
            const daysInLove = Math.floor((now - startData) / (1000 * 60 * 60 * 24));

            // --- æ•°æ®å®šä¹‰ ---
            const goals = ref([]);
            const loading = ref(true);
            const showModal = ref(false);
            const form = ref({ id: null, title: '', currentVal: 0, targetVal: 100, unit: '' });

            // 1. è·å–åˆ—è¡¨ (READ)
            const loadGoals = async () => {
                loading.value = true;
                try {
                    // å‘é€ GET è¯·æ±‚åˆ° /goals/list
                    const res = await fetch(`${API_BASE}/goals/list`);
                    if (res.ok) {
                        goals.value = await res.json();
                    } else {
                        console.error("åç«¯è¿”å›é”™è¯¯:", res.status);
                    }
                } catch(e) { 
                    console.error("ç½‘ç»œè¯·æ±‚å¤±è´¥:", e);
                    // è¿™é‡Œä¸å†ä½¿ç”¨å‡æ•°æ®ï¼Œå¤±è´¥å°±æ˜¯å¤±è´¥ï¼Œæ–¹ä¾¿ä½ è°ƒè¯•
                    alert("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦éƒ¨ç½²æˆåŠŸ");
                } finally {
                    loading.value = false;
                }
            };

            // 2. æäº¤ä¿å­˜ (CREATE / UPDATE)
            const submitForm = async () => {
                if(!form.value.title) { alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©ºå“¦"); return; }
                
                try {
                    // å‘é€ POST è¯·æ±‚åˆ° /goals/save
                    // åç«¯ä¼šè‡ªåŠ¨åˆ¤æ–­ï¼šå¦‚æœæœ‰ id å°±æ˜¯æ›´æ–°ï¼Œæ²¡ id å°±æ˜¯æ–°å¢
                    const res = await fetch(`${API_BASE}/goals/save`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(form.value)
                    });

                    if(res.ok) {
                        alert("ä¿å­˜æˆåŠŸï¼");
                        showModal.value = false;
                        loadGoals(); // åˆ·æ–°åˆ—è¡¨
                    } else {
                        alert("ä¿å­˜å¤±è´¥ï¼Œåç«¯å‡ºé”™äº†");
                    }
                } catch(e) { 
                    alert("ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥"); 
                }
            };

            // 3. åˆ é™¤ (DELETE)
            const deleteGoal = async (id) => {
                if(!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ')) return;
                try {
                    // å‘é€ POST è¯·æ±‚åˆ° /goals/delete/{id}
                    const res = await fetch(`${API_BASE}/goals/delete/${id}`, { method: 'POST' });
                    
                    if(res.ok) {
                        loadGoals(); // åˆ·æ–°
                    } else {
                        alert("åˆ é™¤å¤±è´¥");
                    }
                } catch(e) { 
                    alert("ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥"); 
                }
            };

            // æ‰“å¼€å¼¹çª—é€»è¾‘
            const openModal = (goal = null) => {
                if(goal) {
                    // å¦‚æœä¼ äº† goalï¼Œè¯´æ˜æ˜¯â€œä¿®æ”¹â€ï¼Œå¤åˆ¶ä¸€ä»½æ•°æ®åˆ°è¡¨å•
                    form.value = { ...goal };
                } else {
                    // æ²¡ä¼ å°±æ˜¯â€œæ–°å»ºâ€ï¼Œæ¸…ç©ºè¡¨å•
                    form.value = { id: null, title: '', currentVal: 0, targetVal: 100, unit: '' };
                }
                showModal.value = true;
            };

            // è®¡ç®—è¿›åº¦æ¡ç™¾åˆ†æ¯”
            const getPercent = (goal) => {
                if(!goal.targetVal) return 0;
                let p = (goal.currentVal / goal.targetVal) * 100;
                return p > 100 ? 100 : p.toFixed(1);
            };

            onMounted(loadGoals);

            return { 
                daysInLove, goals, loading, showModal, form, 
                getPercent, openModal, submitForm, deleteGoal 
            };
        }
    }).mount('#app');
</script>
</body>
</html>