<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çªåå°ç®¡ç† âš™ï¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f1f2f6; padding: 20px; color: #2f3542; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { margin-top: 0; color: #57606f; font-size: 22px; display: flex; justify-content: space-between; align-items: center; }
        
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px dashed #dfe4ea; }
        .item-info { flex: 1; }
        .item-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; display: block; }
        .item-tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; background: #ccc;}
        .item-desc { color: #a4b0be; font-size: 12px; }
        .color-preview { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }

        .btn { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-left: 5px; transition: 0.2s; }
        .btn-edit { background: #747d8c; color: white; }
        .btn-del { background: #ff6b81; color: white; }
        .btn-add { background: #2ed573; color: white; padding: 10px 20px; font-size: 14px; }
        .btn-back { background: transparent; color: #57606f; border: 1px solid #ced6e0; text-decoration: none;}

        /* å¼¹çª—æ ·å¼ */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 13px; color: #747d8c; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #dfe4ea; border-radius: 6px; font-size: 14px; }
        input[type="color"] { height: 40px; padding: 2px; }

        /* ç±»å‹é€‰æ‹©å™¨ */
        .type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { flex: 1; padding: 10px; border: 2px solid #dfe4ea; border-radius: 8px; text-align: center; cursor: pointer; color: #a4b0be; font-weight: bold; }
        .type-btn.active { border-color: #3742fa; color: #3742fa; background: #f1f2f6; }

        /* åŠ å‡å·æ§åˆ¶å™¨ */
        .stepper { display: flex; gap: 5px; }
        .stepper input { flex: 1; text-align: center; font-weight: bold; color: #2f3542; }
        .stepper-btn { width: 40px; background: #dfe4ea; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; color: #57606f; }
        .stepper-btn:active { background: #ced6e0; }

        .modal-btns { margin-top: 20px; display: flex; gap: 10px; }
        .btn-save { flex: 1; background: #3742fa; color: white; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; border:none; cursor: pointer;}
        .btn-cancel { flex: 1; background: #f1f2f6; color: #57606f; padding: 12px; border-radius: 8px; font-size: 16px; border:none; cursor: pointer;}
    </style>
</head>
<body>

<div id="app">
    <div class="container">
        <h1>
            <span>âš™ï¸ æ•°æ®ç®¡ç†</span>
            <a href="../index.html" class="btn btn-back">â¬…ï¸ å›ä¸»é¡µ</a>
        </h1>

        <div style="margin-bottom: 20px; text-align: right;">
            <button class="btn btn-add" @click="openModal()">+ æ–°å»ºç›®æ ‡</button>
        </div>

        <div v-if="loading" style="text-align:center; color:#999">åŠ è½½ä¸­...</div>

        <div class="item-row" v-for="item in list" :key="item.id">
            <div class="item-info">
                <span class="item-title">
                    <span class="color-preview" :style="{background: item.color || '#ccc'}"></span>
                    {{ item.title }}
                    <span class="item-tag" :style="{background: item.type === 2 ? '#ff9f43' : '#2ed573'}">
                        {{ item.type === 2 ? 'çºªå¿µæ—¥' : 'ç´¯ç§¯' }}
                    </span>
                </span>
                
                <span class="item-desc" v-if="item.type === 2">
                    èµ·å§‹: {{ item.startDate }} | ç›®æ ‡: {{ item.targetVal }} å¤©
                </span>
                <span class="item-desc" v-else>
                    è¿›åº¦: {{ item.currentVal }} / {{ item.targetVal }} {{ item.unit }}
                </span>
            </div>
            <div>
                <button class="btn btn-edit" @click="openModal(item)">ç¼–è¾‘</button>
                <button class="btn btn-del" @click="deleteItem(item.id)">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <div class="modal-mask" v-if="showModal">
        <div class="modal">
            <h3 style="margin-top:0">{{ form.id ? 'ç¼–è¾‘ç›®æ ‡' : 'æ–°å»ºç›®æ ‡' }}</h3>
            
            <div class="form-group">
                <label>é€‰æ‹©ç±»å‹</label>
                <div class="type-selector">
                    <div class="type-btn" :class="{active: form.type === 1}" @click="form.type = 1">
                        ğŸ’° æ•°å€¼ç´¯ç§¯<br><span style="font-size:10px;font-weight:normal">(æ”’é»„é‡‘/å­˜æ¬¾)</span>
                    </div>
                    <div class="type-btn" :class="{active: form.type === 2}" @click="form.type = 2">
                        ğŸ“… çºªå¿µæ—¥<br><span style="font-size:10px;font-weight:normal">(æ‹çˆ±/æˆ’çƒŸ)</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>æ ‡é¢˜åç§°</label>
                <input v-model="form.title" placeholder="ä¾‹å¦‚ï¼šæ”’é»„é‡‘ / æ‹çˆ±çºªå¿µæ—¥">
            </div>

            <div v-if="form.type === 2">
                <div class="form-group">
                    <label>èµ·å§‹æ—¥æœŸ (ä»å“ªå¤©å¼€å§‹)</label>
                    <input type="date" v-model="form.startDate">
                </div>
                <div class="form-group">
                    <label>ä¸‹ä¸€ä¸ªç›®æ ‡é‡Œç¨‹ç¢‘ (å¤©)</label>
                    <input type="number" v-model="form.targetVal" placeholder="ä¾‹å¦‚ï¼š1000">
                </div>
            </div>

            <div v-if="form.type === 1">
                <div class="form-group">
                    <label>å½“å‰è¿›åº¦ (æ”¯æŒåŠ å‡å¾®è°ƒ)</label>
                    <div class="stepper">
                        <button class="stepper-btn" @click="adjustVal(-1)">-</button>
                        <input type="number" v-model="form.currentVal" step="0.1">
                        <button class="stepper-btn" @click="adjustVal(1)">+</button>
                    </div>
                    <div style="margin-top:5px; display:flex; gap:5px;">
                         <button class="btn" style="background:#eee" @click="adjustVal(10)">+10</button>
                         <button class="btn" style="background:#eee" @click="adjustVal(-10)">-10</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>ç›®æ ‡æ€»æ•°</label>
                    <input type="number" v-model="form.targetVal" step="0.1">
                </div>
            </div>

            <div class="form-group">
                <label>å•ä½ (é€‰å¡«)</label>
                <input v-model="form.unit" placeholder="ä¾‹å¦‚ï¼šå…‹ / å…ƒ">
            </div>

            <div class="form-group">
                <label>ä¸»é¢˜é¢œè‰²</label>
                <input type="color" v-model="form.color">
            </div>

            <div class="modal-btns">
                <button class="btn-save" @click="save">ä¿å­˜æäº¤</button>
                <button class="btn-cancel" @click="showModal = false">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;
    const API_BASE = 'https://darlingweb.onrender.com';

    createApp({
        setup() {
            const list = ref([]);
            const loading = ref(false);
            const showModal = ref(false);
            
            // é»˜è®¤è¡¨å•æ•°æ®
            const defaultForm = { 
                id: null, 
                title: '', 
                type: 1, // é»˜è®¤ä¸ºæ•°å€¼å‹
                startDate: '', // çºªå¿µæ—¥ç”¨
                currentVal: 0, // æ•°å€¼å‹ç”¨
                targetVal: 100, 
                unit: '', 
                color: '#6c5ce7' 
            };
            const form = ref({ ...defaultForm });

            const loadData = async () => {
                loading.value = true;
                try {
                    const res = await fetch(`${API_BASE}/goals/list`);
                    list.value = await res.json();
                } catch(e) { alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯"); }
                loading.value = false;
            };

            const openModal = (item = null) => {
                if (item) {
                    form.value = { ...item };
                    // å¦‚æœåç«¯æ²¡å­˜typeï¼Œé»˜è®¤ä¸º1
                    if(!form.value.type) form.value.type = 1;
                } else {
                    form.value = { ...defaultForm };
                    // è®¾ç½®æ—¥æœŸé»˜è®¤å€¼ä¸ºä»Šå¤©ï¼Œæ–¹ä¾¿é€‰æ‹©
                    const today = new Date().toISOString().split('T')[0];
                    form.value.startDate = today;
                }
                showModal.value = true;
            };

            // å¿«æ·åŠ å‡åŠŸèƒ½
            const adjustVal = (amount) => {
                // ç¡®ä¿ currentVal æ˜¯æ•°å­—
                let val = parseFloat(form.value.currentVal) || 0;
                val += amount;
                // ä¿ç•™2ä½å°æ•°ï¼Œé˜²æ­¢å‡ºç° 0.1 + 0.2 = 0.3000004
                form.value.currentVal = Math.round(val * 100) / 100;
            };

            const save = async () => {
                try {
                    // ç®€å•çš„æ ¡éªŒ
                    if(form.value.type === 2 && !form.value.startDate) {
                        alert("çºªå¿µæ—¥ç±»å‹å¿…é¡»é€‰æ‹©èµ·å§‹æ—¥æœŸï¼");
                        return;
                    }

                    await fetch(`${API_BASE}/goals/save`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(form.value)
                    });
                    showModal.value = false;
                    loadData();
                } catch(e) { alert("ä¿å­˜å¤±è´¥"); }
            };

            const deleteItem = async (id) => {
                if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
                try {
                    await fetch(`${API_BASE}/goals/delete/${id}`, { method: 'POST' });
                    loadData();
                } catch(e) { alert("åˆ é™¤å¤±è´¥"); }
            };

            onMounted(loadData);

            return { list, loading, showModal, form, openModal, save, deleteItem, adjustVal };
        }
    }).mount('#app');
</script>
</body>
</html>