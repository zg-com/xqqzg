<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èµ›åšæœ¨é±¼ ğŸŸ</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #000; /* çº¯é»‘èƒŒæ™¯ï¼Œçªå‡ºèµ›åšæ„Ÿ */
            color: #fff;
            font-family: "Microsoft YaHei", sans-serif;
            height: 100vh; height: 100dvh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: space-between;
            overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* é¡¶éƒ¨æ•°æ®æ  */
        .header {
            width: 100%; padding: 40px 20px 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 10;
        }
        .score-container { text-align: left; }
        .score-label { font-size: 14px; color: #888; letter-spacing: 2px; text-transform: uppercase; }
        .score-val { 
            font-size: 56px; font-weight: bold; 
            background: linear-gradient(to bottom, #f1c40f, #bf953f);
            -webkit-background-clip: text; color: transparent;
            font-family: monospace; text-shadow: 0 0 20px rgba(241, 196, 15, 0.3);
        }

        .btn-icon {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #f1c40f; width: 44px; height: 44px; border-radius: 50%;
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; margin-left: 10px; backdrop-filter: blur(5px);
        }
        .btn-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.3); }

        /* æœ¨é±¼ä¸»ä½“åŒºåŸŸ */
        .game-area {
            flex: 1; width: 100%; position: relative;
            display: flex; justify-content: center; align-items: center;
            /* ç‚¹å‡»æ•´ä¸ªåŒºåŸŸéƒ½ç®—æ•²å‡» */
            cursor: pointer; 
        }

        /* æœ¨é±¼ SVG */
        .muyu-wrapper {
            position: relative; width: 260px; height: 260px;
        }
        
        .muyu-svg {
            width: 100%; height: 100%;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
            transform-origin: center bottom;
            transition: transform 0.08s ease-out;
        }
        /* è¢«æ•²å‡»æ—¶çš„å½¢å˜ */
        .muyu-svg.tapping { transform: scale(0.95) translateY(5px); }

        /* æœ¨æ§Œ SVG */
        .stick-svg {
            position: absolute; top: -40px; right: -60px;
            width: 120px; height: 120px;
            transform-origin: bottom right;
            transform: rotate(0deg);
            pointer-events: none; /* ç©¿é€ç‚¹å‡» */
            transition: transform 0.05s ease-in;
        }
        /* æ•²å‡»åŠ¨ä½œ */
        .stick-svg.hitting { transform: rotate(-30deg) translate(-20px, 20px); }

        /* åŠŸå¾·+1 æµ®åŠ¨ç‰¹æ•ˆ */
        .merit-text {
            position: absolute; left: 50%; top: 30%;
            transform: translate(-50%, -50%);
            color: #fff; font-size: 24px; font-weight: bold;
            pointer-events: none; opacity: 0; white-space: nowrap;
        }
        .merit-text.anim {
            animation: floatUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes floatUp {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -40px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1); opacity: 0; }
        }

        /* åº•éƒ¨ */
        .footer {
            padding: 0 20px 40px; width: 100%; box-sizing: border-box;
            display: flex; justify-content: center; gap: 15px; z-index: 10;
        }
        .btn {
            padding: 12px 25px; border-radius: 30px; font-size: 15px; font-weight: bold;
            border: 1px solid #555; background: rgba(0,0,0,0.5); color: #ccc;
            cursor: pointer; text-decoration: none; backdrop-filter: blur(5px);
        }
        .btn-gold { 
            border-color: #f1c40f; color: #121212; 
            background: linear-gradient(135deg, #f1c40f, #e67e22); 
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3);
        }

        /* å¼¹çª— */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 99; backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .card {
            background: #1e1e1e; width: 80%; max-width: 320px; padding: 25px;
            border-radius: 20px; text-align: center; border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .role-btn {
            display: block; width: 100%; margin: 15px 0; padding: 15px;
            background: transparent; border: 1px solid #555; color: #ccc;
            border-radius: 8px; font-size: 16px; cursor: pointer;
        }
        .rank-list { list-style: none; padding: 0; text-align: left; max-height: 300px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #333; color: #888; }
        .rank-highlight { color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <div class="score-container">
            <div class="score-label">ç´¯è®¡åŠŸå¾·</div>
            <div class="score-val">{{ merit }}</div>
        </div>
        <div style="display:flex">
            <button class="btn-icon" @click="toggleSound">
                {{ soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡' }}
            </button>
            <button class="btn-icon" @click="openRank">ğŸ†</button>
        </div>
    </div>

    <div class="game-area" @pointerdown="tapFish">
        <div class="muyu-wrapper">
            <svg class="stick-svg" :class="{hitting: isTapping}" viewBox="0 0 100 100">
                <ellipse cx="20" cy="80" rx="15" ry="12" fill="#8d6e63"/>
                <path d="M20 80 L80 20" stroke="#5d4037" stroke-width="6" stroke-linecap="round"/>
            </svg>

            <svg class="muyu-svg" :class="{tapping: isTapping}" viewBox="0 0 200 180">
                <defs>
                    <linearGradient id="woodGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#d35400;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#8e44ad;stop-opacity:1" /> </linearGradient>
                    <radialGradient id="shine" cx="30%" cy="30%" r="50%">
                        <stop offset="0%" style="stop-color:#e67e22;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#a04000;stop-opacity:1" />
                    </radialGradient>
                </defs>
                
                <path d="M20 90 Q20 20 100 20 Q180 20 180 90 Q180 160 100 160 Q20 160 20 90 Z" 
                      fill="url(#shine)" stroke="#3e2723" stroke-width="2"/>
                
                <path d="M40 90 Q100 80 160 90 Q100 120 40 90" 
                      fill="#1a1a1a" stroke="#3e2723" stroke-width="2"/>
                
                <path d="M90 40 Q100 30 110 40" fill="none" stroke="#5d4037" stroke-width="3" stroke-linecap="round"/>
                <path d="M85 45 Q100 35 115 45" fill="none" stroke="#5d4037" stroke-width="3" stroke-linecap="round"/>
            </svg>
        </div>

        <div v-for="t in floatTexts" :key="t.id" class="merit-text anim" :style="{left: t.x + 'px', top: t.y + 'px'}">
            åŠŸå¾· +1
        </div>
    </div>

    <div class="footer">
        <a href="/unit/games.html" class="btn">é€€å‡ºç¦…å®š</a>
        <button class="btn btn-gold" @click="saveAndExit">è®°å½•åŠŸå¾·</button>
    </div>

    <div class="modal-overlay" :class="{show: showRoleSelect}">
        <div class="card">
            <h3 style="color:#f1c40f">æ–½ä¸»æ˜¯å“ªä½ï¼ŸğŸ™</h3>
            <button class="role-btn" @click="selectRole('ğŸ‘¦ å“¥å“¥')">ğŸ‘¦ å“¥å“¥</button>
            <button class="role-btn" @click="selectRole('ğŸ‘§ å®è´')">ğŸ‘§ å®è´</button>
        </div>
    </div>

    <div class="modal-overlay" :class="{show: showRank}" @click.self="showRank = false">
        <div class="card">
            <h3 style="color:#f1c40f; margin-top:0">ğŸ† åŠŸå¾·æ€»æ¦œ</h3>
            <ul class="rank-list">
                <li class="rank-item" v-for="(item, index) in rankList" :key="index">
                    <span>
                        <span v-if="index<3">ğŸ”¥</span>
                        <span v-else>{{ index + 1 }}.</span>
                        {{ item.playerName }}
                    </span>
                    <span class="rank-highlight">{{ item.score }}</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;
    const API_BASE = 'https://darlingweb.onrender.com';

    createApp({
        setup() {
            const merit = ref(0);
            const isTapping = ref(false);
            const floatTexts = ref([]);
            const soundEnabled = ref(true);
            
            const showRoleSelect = ref(false);
            const showRank = ref(false);
            const rankList = ref([]);
            const currentPlayer = ref(localStorage.getItem('darling_player_name') || '');

            let audioCtx = null;

            const initAudio = () => {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            };

            const toggleSound = () => {
                soundEnabled.value = !soundEnabled.value;
                if (soundEnabled.value) initAudio();
            };

            // æ¨¡æ‹Ÿæœ¨é±¼å£°éŸ³ï¼šä½¿ç”¨ä¸‰è§’æ³¢ï¼Œå¿«é€Ÿè¡°å‡
            const playWoodSound = () => {
                if (!soundEnabled.value || !audioCtx) return;
                
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                // æœ¨é±¼å£°éŸ³é€šå¸¸æ¯”è¾ƒæ²‰é—·ï¼Œé¢‘ç‡å¤§æ¦‚åœ¨ 300-600Hz
                osc.type = 'triangle'; // ä¸‰è§’æ³¢æ¯”æ­£å¼¦æ³¢æ›´æœ‰â€œæœ¨å¤´â€è´¨æ„Ÿ
                osc.frequency.setValueAtTime(450, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1); // é¢‘ç‡å¿«é€Ÿä¸‹é™
                
                // éŸ³é‡åŒ…ç»œï¼šå†²å‡»æ„Ÿå¼ºï¼Œè¡°å‡å¿«
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            };

            const tapFish = (e) => {
                initAudio();
                
                // 1. æ•°æ®
                merit.value++;

                // 2. åŠ¨ç”»çŠ¶æ€
                isTapping.value = true;
                setTimeout(() => isTapping.value = false, 80); // æ•²å‡»åŠ¨ä½œå›å¼¹æ—¶é—´

                // 3. å£°éŸ³
                playWoodSound();

                // 4. éœ‡åŠ¨
                if (navigator.vibrate) navigator.vibrate(20);

                // 5. æµ®åŠ¨æ–‡å­— (åœ¨ç‚¹å‡»ä½ç½®é™„è¿‘ï¼Œæˆ–è€…å±å¹•ä¸­å¿ƒ)
                // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬è®©å®ƒä»æœ¨é±¼ä¸­å¿ƒé£˜èµ·æ¥
                const id = Date.now();
                // éšæœºå¾®è°ƒä½ç½®
                const offset = (Math.random() - 0.5) * 40;
                // è¿™é‡Œçš„ x, y æ˜¯ç›¸å¯¹äº game-area ä¸­å¿ƒçš„åç§»ï¼Œå®é™…ä¸Šæˆ‘ä»¬ç”¨ CSS left 50% å±…ä¸­
                // åªè¦ç»™ä¸€ä¸ªéšæœºåç§»é‡å³å¯
                
                floatTexts.value.push({ id });
                setTimeout(() => {
                    floatTexts.value = floatTexts.value.filter(t => t.id !== id);
                }, 800);

                // 6. è‡ªåŠ¨ä¿å­˜ (ç§¯å°‘æˆå¤šï¼Œæ¯10ä¸‹å­˜ä¸€æ¬¡)
                if (merit.value % 10 === 0) submitScore(true);
            };

            const selectRole = (name) => {
                currentPlayer.value = name;
                localStorage.setItem('darling_player_name', name);
                showRoleSelect.value = false;
            };

            const submitScore = async (silent = false) => {
                if(!currentPlayer.value) return;
                try {
                    await fetch(`${API_BASE}/game/submit`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            playerName: currentPlayer.value,
                            score: merit.value,
                            gameType: 3 
                        })
                    });
                    if(!silent) alert("åŠŸå¾·å·²è®°å½•åœ¨å†Œ ğŸ™");
                } catch(e) {}
            };

            const saveAndExit = async () => {
                await submitScore(true);
                window.location.href = '/unit/games.html';
            };

            const openRank = async () => {
                try {
                    const res = await fetch(`${API_BASE}/game/rank?type=3`);
                    rankList.value = await res.json();
                    showRank.value = true;
                } catch(e) {}
            };

            onMounted(() => {
                if (!currentPlayer.value) {
                    showRoleSelect.value = true;
                }
            });

            return {
                merit, isTapping, floatTexts, soundEnabled, toggleSound,
                showRoleSelect, showRank, rankList,
                tapFish, selectRole, saveAndExit, openRank
            };
        }
    }).mount('#app');
</script>
</body>
</html>